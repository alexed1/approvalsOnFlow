From 7bb8766a35ac98a6375e4a36e23724b906a498a3 Mon Sep 17 00:00:00 2001
From: Alex Edelstein <aedelstein@salesforce.comm>
Date: Sun, 29 Sep 2019 20:20:50 -0700
Subject: [PATCH 2/4] flow improvements

---
 .../classes/FindRecordsInCollection.cls       |  10 +-
 .../AP_Edit_Approval_Processes.flow-meta.xml  |   6 +-
 ...Manage_Approval_Process_Step.flow-meta.xml |  58 ++++++++--
 ...AP_Manage_Approval_Processes.flow-meta.xml | 105 +++++++++++++++---
 .../AP_Manage_Step_Approvers.flow-meta.xml    |  24 ++--
 .../main/default/flows/TestFlow.flow-meta.xml |  48 ++++++++
 6 files changed, 215 insertions(+), 36 deletions(-)
 create mode 100644 force-app/main/default/flows/TestFlow.flow-meta.xml

diff --git a/force-app/main/default/classes/FindRecordsInCollection.cls b/force-app/main/default/classes/FindRecordsInCollection.cls
index 157f4dc..4a941c1 100644
--- a/force-app/main/default/classes/FindRecordsInCollection.cls
+++ b/force-app/main/default/classes/FindRecordsInCollection.cls
@@ -11,11 +11,13 @@ public with sharing class FindRecordsInCollection {
         //Create a Results object to hold the return values
         Results response = new Results();
 		System.debug('inputCollection.size() is: ' + inputCollection.size());
-        System.debug(inputCollection[0]);
-        if(inputCollection.size() > 0) {
+        System.debug('inputCollection[0] is ' + inputCollection[0]);
+        System.debug('inputCollection is ' + inputCollection);
+        System.debug('inputCollection isempty: ' + inputCollection.isEmpty());
+        //if flow does a query that returns no results and passes that to this action, it actually shows up
+        // as a List containing a single member of 'null', making the null check different
+        if(inputCollection.size() > 0 && inputCollection[0] != null) {
             
-            //TRACE HERE
-            //
             //given a list of items, and a search string, find all of the matches
             //iterate through input collection
             //check the value of the current input  
diff --git a/force-app/main/default/flows/AP_Edit_Approval_Processes.flow-meta.xml b/force-app/main/default/flows/AP_Edit_Approval_Processes.flow-meta.xml
index abd6476..d65a77c 100644
--- a/force-app/main/default/flows/AP_Edit_Approval_Processes.flow-meta.xml
+++ b/force-app/main/default/flows/AP_Edit_Approval_Processes.flow-meta.xml
@@ -3,7 +3,7 @@
     <actionCalls>
         <name>Find_Selected_Step_Definition</name>
         <label>Find Selected Step Definition</label>
-        <locationX>1509</locationX>
+        <locationX>1508</locationX>
         <locationY>310</locationY>
         <actionName>FindRecordsInCollection</actionName>
         <actionType>apex</actionType>
@@ -148,8 +148,8 @@ TODO: implement the enforceSingleMember flag and detect returned errors</descrip
     <decisions>
         <name>Done_Handling_Steps</name>
         <label>Done Handling Steps?</label>
-        <locationX>1322</locationX>
-        <locationY>400</locationY>
+        <locationX>1345</locationX>
+        <locationY>440</locationY>
         <defaultConnector>
             <targetReference>Find_Selected_Step_Definition</targetReference>
         </defaultConnector>
diff --git a/force-app/main/default/flows/AP_Manage_Approval_Process_Step.flow-meta.xml b/force-app/main/default/flows/AP_Manage_Approval_Process_Step.flow-meta.xml
index 2af731f..5d8641c 100644
--- a/force-app/main/default/flows/AP_Manage_Approval_Process_Step.flow-meta.xml
+++ b/force-app/main/default/flows/AP_Manage_Approval_Process_Step.flow-meta.xml
@@ -1,5 +1,36 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <Flow xmlns="http://soap.sforce.com/2006/04/metadata" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
+    <assignments>
+        <description>On an edit the full Step Def is passed in from the parent. In the case of an Add, we&#39;ve just received the Name and generated the ID. The ID has just been overwritten onto the main Step Def variable, and now we need to add the Name.</description>
+        <name>Assign_Name_to</name>
+        <label>Update Current Step Def</label>
+        <locationX>738</locationX>
+        <locationY>522</locationY>
+        <assignmentItems>
+            <assignToReference>curApprovalProcessStepDefinition.Name</assignToReference>
+            <operator>Assign</operator>
+            <value>
+                <elementReference>Proposed_Step_Name</elementReference>
+            </value>
+        </assignmentItems>
+        <assignmentItems>
+            <assignToReference>curApprovalProcessStepDefinition.ApprovalFlow_API_Name__c</assignToReference>
+            <operator>Assign</operator>
+            <value>
+                <stringValue>&quot;&quot;</stringValue>
+            </value>
+        </assignmentItems>
+        <assignmentItems>
+            <assignToReference>curApprovalProcessStepDefinition.RejectionFlow_API_Name__c</assignToReference>
+            <operator>Assign</operator>
+            <value>
+                <stringValue>&quot;&quot;</stringValue>
+            </value>
+        </assignmentItems>
+        <connector>
+            <targetReference>Step_Added</targetReference>
+        </connector>
+    </assignments>
     <choices>
         <name>AlwaysEnter</name>
         <choiceText>All records should enter this step.</choiceText>
@@ -198,10 +229,11 @@
     <recordCreates>
         <name>Create_Approval_Process_Step_Record</name>
         <label>Create Approval Process Step Record</label>
-        <locationX>583</locationX>
-        <locationY>517</locationY>
+        <locationX>591</locationX>
+        <locationY>522</locationY>
+        <assignRecordIdToReference>curApprovalProcessStepDefinition.Id</assignRecordIdToReference>
         <connector>
-            <targetReference>Step_Added</targetReference>
+            <targetReference>Assign_Name_to</targetReference>
         </connector>
         <inputAssignments>
             <field>ApprovalProcessDefinition__c</field>
@@ -226,6 +258,13 @@
         <connector>
             <targetReference>Similar_Name_Exist</targetReference>
         </connector>
+        <filters>
+            <field>ApprovalProcessDefinition__c</field>
+            <operator>EqualTo</operator>
+            <value>
+                <elementReference>curApprovalProcessDefinition.Id</elementReference>
+            </value>
+        </filters>
         <filters>
             <field>Name</field>
             <operator>EqualTo</operator>
@@ -342,7 +381,7 @@
     <screens>
         <name>Select_Step_Actions</name>
         <label>Select Step Actions</label>
-        <locationX>983</locationX>
+        <locationX>984</locationX>
         <locationY>152</locationY>
         <allowBack>true</allowBack>
         <allowFinish>true</allowFinish>
@@ -417,11 +456,14 @@
         <description>IMPORTANT! This screen forces an important transaction. removing this will cause bugs.</description>
         <name>Step_Added</name>
         <label>Step Added</label>
-        <locationX>734</locationX>
-        <locationY>520</locationY>
+        <locationX>876</locationX>
+        <locationY>523</locationY>
         <allowBack>true</allowBack>
         <allowFinish>true</allowFinish>
         <allowPause>true</allowPause>
+        <connector>
+            <targetReference>Select_Step_Actions</targetReference>
+        </connector>
         <fields>
             <name>dispAddComplete</name>
             <fieldText>&lt;p&gt;Step added.&lt;/p&gt;</fieldText>
@@ -453,7 +495,7 @@
             <targetReference>Which_Operation</targetReference>
         </connector>
     </start>
-    <status>Active</status>
+    <status>Draft</status>
     <subflows>
         <name>Manage_Approvers_for_Step</name>
         <label>Manage Approvers for Step</label>
@@ -464,7 +506,7 @@
         </connector>
         <flowName>AP_Manage_Step_Approvers</flowName>
         <inputAssignments>
-            <name>curApprovalStep</name>
+            <name>curApprovalStepDef</name>
             <value>
                 <elementReference>curApprovalProcessStepDefinition</elementReference>
             </value>
diff --git a/force-app/main/default/flows/AP_Manage_Approval_Processes.flow-meta.xml b/force-app/main/default/flows/AP_Manage_Approval_Processes.flow-meta.xml
index fe49c61..8c89dfe 100644
--- a/force-app/main/default/flows/AP_Manage_Approval_Processes.flow-meta.xml
+++ b/force-app/main/default/flows/AP_Manage_Approval_Processes.flow-meta.xml
@@ -55,6 +55,14 @@
             <stringValue>Delete</stringValue>
         </value>
     </choices>
+    <choices>
+        <name>deleteChoice</name>
+        <choiceText>Delete an Approval Process</choiceText>
+        <dataType>String</dataType>
+        <value>
+            <stringValue>delete</stringValue>
+        </value>
+    </choices>
     <choices>
         <name>Done</name>
         <choiceText>Done with steps</choiceText>
@@ -85,14 +93,14 @@
         <locationX>1010</locationX>
         <locationY>322</locationY>
         <defaultConnector>
-            <targetReference>Get_Selected_Approval_Process</targetReference>
+            <targetReference>Edit_or_Delete</targetReference>
         </defaultConnector>
         <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
         <rules>
             <name>Is_Null</name>
             <conditionLogic>and</conditionLogic>
             <conditions>
-                <leftValueReference>existingApprovalProcessDefinitionId</leftValueReference>
+                <leftValueReference>selectedApprovalProcessDefinitionId</leftValueReference>
                 <operator>IsNull</operator>
                 <rightValue>
                     <booleanValue>true</booleanValue>
@@ -151,8 +159,8 @@
             <label>Create Approval Process</label>
         </rules>
         <rules>
-            <name>Edit_Approval_Process</name>
-            <conditionLogic>and</conditionLogic>
+            <name>Edit_or_Delete_Approval_Process</name>
+            <conditionLogic>or</conditionLogic>
             <conditions>
                 <leftValueReference>ApprovalProcessAction</leftValueReference>
                 <operator>EqualTo</operator>
@@ -160,10 +168,42 @@
                     <elementReference>edit_choice</elementReference>
                 </rightValue>
             </conditions>
+            <conditions>
+                <leftValueReference>ApprovalProcessAction</leftValueReference>
+                <operator>EqualTo</operator>
+                <rightValue>
+                    <elementReference>deleteChoice</elementReference>
+                </rightValue>
+            </conditions>
             <connector>
                 <targetReference>Get_Approval_Process_Definitions</targetReference>
             </connector>
-            <label>Edit Approval Process</label>
+            <label>Edit or Delete Approval Process</label>
+        </rules>
+    </decisions>
+    <decisions>
+        <name>Edit_or_Delete</name>
+        <label>Edit or Delete?</label>
+        <locationX>1008</locationX>
+        <locationY>524</locationY>
+        <defaultConnector>
+            <targetReference>Delete_Selected_Approval_Process</targetReference>
+        </defaultConnector>
+        <defaultConnectorLabel>Delete</defaultConnectorLabel>
+        <rules>
+            <name>EditApprovalProcess2</name>
+            <conditionLogic>and</conditionLogic>
+            <conditions>
+                <leftValueReference>ApprovalProcessAction</leftValueReference>
+                <operator>EqualTo</operator>
+                <rightValue>
+                    <elementReference>edit_choice</elementReference>
+                </rightValue>
+            </conditions>
+            <connector>
+                <targetReference>Get_Selected_Approval_Process</targetReference>
+            </connector>
+            <label>Edit</label>
         </rules>
     </decisions>
     <decisions>
@@ -217,6 +257,23 @@
         </connector>
         <inputReference>curApprovalProcessDefinition</inputReference>
     </recordCreates>
+    <recordDeletes>
+        <name>Delete_Selected_Approval_Process</name>
+        <label>Delete Selected Approval Process</label>
+        <locationX>1015</locationX>
+        <locationY>1091</locationY>
+        <connector>
+            <targetReference>DeleteConfirmation</targetReference>
+        </connector>
+        <filters>
+            <field>Id</field>
+            <operator>EqualTo</operator>
+            <value>
+                <elementReference>selectedApprovalProcessDefinitionId</elementReference>
+            </value>
+        </filters>
+        <object>ApprovalProcessDefinition__c</object>
+    </recordDeletes>
     <recordLookups>
         <name>Get_Approval_Process_Definitions</name>
         <label>Get Approval Process Definitions</label>
@@ -248,7 +305,7 @@
             <field>Id</field>
             <operator>EqualTo</operator>
             <value>
-                <elementReference>existingApprovalProcessDefinitionId</elementReference>
+                <elementReference>selectedApprovalProcessDefinitionId</elementReference>
             </value>
         </filters>
         <object>ApprovalProcessDefinition__c</object>
@@ -278,8 +335,8 @@
     <screens>
         <name>Create_or_Edit</name>
         <label>Create or Edit</label>
-        <locationX>263</locationX>
-        <locationY>50</locationY>
+        <locationX>133</locationX>
+        <locationY>49</locationY>
         <allowBack>true</allowBack>
         <allowFinish>true</allowFinish>
         <allowPause>true</allowPause>
@@ -295,6 +352,7 @@
             <name>ApprovalProcessAction</name>
             <choiceReferences>create_Choice</choiceReferences>
             <choiceReferences>edit_choice</choiceReferences>
+            <choiceReferences>deleteChoice</choiceReferences>
             <dataType>String</dataType>
             <fieldText>Select an Action</fieldText>
             <fieldType>RadioButtons</fieldType>
@@ -303,6 +361,25 @@
         <showFooter>true</showFooter>
         <showHeader>false</showHeader>
     </screens>
+    <screens>
+        <name>DeleteConfirmation</name>
+        <label>DeleteConfirmation</label>
+        <locationX>123</locationX>
+        <locationY>1363</locationY>
+        <allowBack>true</allowBack>
+        <allowFinish>true</allowFinish>
+        <allowPause>true</allowPause>
+        <connector>
+            <targetReference>Create_or_Edit</targetReference>
+        </connector>
+        <fields>
+            <name>dispDeleteConfirm</name>
+            <fieldText>&lt;p&gt;Approval Process deleted.&lt;/p&gt;</fieldText>
+            <fieldType>DisplayText</fieldType>
+        </fields>
+        <showFooter>true</showFooter>
+        <showHeader>true</showHeader>
+    </screens>
     <screens>
         <name>Error</name>
         <label>Error!!</label>
@@ -426,7 +503,7 @@
             </inputParameters>
             <isRequired>true</isRequired>
             <outputParameters>
-                <assignToReference>existingApprovalProcessDefinitionId</assignToReference>
+                <assignToReference>selectedApprovalProcessDefinitionId</assignToReference>
                 <name>recordId</name>
             </outputParameters>
         </fields>
@@ -507,18 +584,18 @@
         </value>
     </variables>
     <variables>
-        <name>existingApprovalProcessDefinitionId</name>
+        <description>This is the record for which approval is being sought.</description>
+        <name>recordId</name>
         <dataType>String</dataType>
         <isCollection>false</isCollection>
-        <isInput>false</isInput>
+        <isInput>true</isInput>
         <isOutput>false</isOutput>
     </variables>
     <variables>
-        <description>This is the record for which approval is being sought.</description>
-        <name>recordId</name>
+        <name>selectedApprovalProcessDefinitionId</name>
         <dataType>String</dataType>
         <isCollection>false</isCollection>
-        <isInput>true</isInput>
+        <isInput>false</isInput>
         <isOutput>false</isOutput>
     </variables>
 </Flow>
diff --git a/force-app/main/default/flows/AP_Manage_Step_Approvers.flow-meta.xml b/force-app/main/default/flows/AP_Manage_Step_Approvers.flow-meta.xml
index e4d586e..422e4af 100644
--- a/force-app/main/default/flows/AP_Manage_Step_Approvers.flow-meta.xml
+++ b/force-app/main/default/flows/AP_Manage_Step_Approvers.flow-meta.xml
@@ -26,8 +26,8 @@
     <assignments>
         <name>Set_Type_to_Build_List</name>
         <label>Set Type to Build List</label>
-        <locationX>773</locationX>
-        <locationY>260</locationY>
+        <locationX>763</locationX>
+        <locationY>261</locationY>
         <assignmentItems>
             <assignToReference>curApprovalStepDef.SingleApproverOrMultiple__c</assignToReference>
             <operator>Assign</operator>
@@ -43,7 +43,7 @@
             </value>
         </assignmentItems>
         <connector>
-            <targetReference>Update_Approver</targetReference>
+            <targetReference>Update_Step_Def_with_Approver_Details</targetReference>
         </connector>
     </assignments>
     <assignments>
@@ -73,13 +73,13 @@
     <assignments>
         <name>Set_Type_to_Queue</name>
         <label>Set Type to Queue</label>
-        <locationX>449</locationX>
-        <locationY>459</locationY>
+        <locationX>480</locationX>
+        <locationY>456</locationY>
         <assignmentItems>
             <assignToReference>curApprover.Name</assignToReference>
             <operator>Assign</operator>
             <value>
-                <elementReference>Select_Queue</elementReference>
+                <elementReference>QueuePicker</elementReference>
             </value>
         </assignmentItems>
         <assignmentItems>
@@ -275,8 +275,18 @@
         <label>Update Approver</label>
         <locationX>795</locationX>
         <locationY>450</locationY>
+        <connector>
+            <targetReference>Update_Step_Def_with_Approver_Details</targetReference>
+        </connector>
         <inputReference>curApprover</inputReference>
     </recordUpdates>
+    <recordUpdates>
+        <name>Update_Step_Def_with_Approver_Details</name>
+        <label>Update Step Def with Approver Details</label>
+        <locationX>928</locationX>
+        <locationY>449</locationY>
+        <inputReference>curApprovalStepDef</inputReference>
+    </recordUpdates>
     <screens>
         <description>get back a list of Approvers and update</description>
         <name>screenSelect_Approvers</name>
@@ -369,7 +379,7 @@
             <isRequired>false</isRequired>
         </fields>
         <fields>
-            <name>Select_Queue</name>
+            <name>QueuePicker</name>
             <dataType>String</dataType>
             <fieldText>Select Queue (lookup placeholder)</fieldText>
             <fieldType>InputField</fieldType>
diff --git a/force-app/main/default/flows/TestFlow.flow-meta.xml b/force-app/main/default/flows/TestFlow.flow-meta.xml
new file mode 100644
index 0000000..9336e5e
--- /dev/null
+++ b/force-app/main/default/flows/TestFlow.flow-meta.xml
@@ -0,0 +1,48 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
+    <actionCalls>
+        <name>FindRecordsInCollection</name>
+        <label>FindRecordsInCollection</label>
+        <locationX>217</locationX>
+        <locationY>50</locationY>
+        <actionName>FindRecordsInCollection</actionName>
+        <actionType>apex</actionType>
+        <inputParameters>
+            <name>inputCollection</name>
+            <value>
+                <elementReference>curInputCollection</elementReference>
+            </value>
+        </inputParameters>
+    </actionCalls>
+    <interviewLabel>TestFlow {!$Flow.CurrentDateTime}</interviewLabel>
+    <label>TestFlow</label>
+    <processMetadataValues>
+        <name>BuilderType</name>
+        <value>
+            <stringValue>LightningFlowBuilder</stringValue>
+        </value>
+    </processMetadataValues>
+    <processMetadataValues>
+        <name>OriginBuilderType</name>
+        <value>
+            <stringValue>LightningFlowBuilder</stringValue>
+        </value>
+    </processMetadataValues>
+    <processType>Flow</processType>
+    <start>
+        <locationX>50</locationX>
+        <locationY>50</locationY>
+        <connector>
+            <targetReference>FindRecordsInCollection</targetReference>
+        </connector>
+    </start>
+    <status>Draft</status>
+    <variables>
+        <name>curInputCollection</name>
+        <dataType>SObject</dataType>
+        <isCollection>true</isCollection>
+        <isInput>false</isInput>
+        <isOutput>false</isOutput>
+        <objectType>ApprovalProcessStepDefinition__c</objectType>
+    </variables>
+</Flow>
-- 
2.21.0 (Apple Git-120)

